<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Scratch 3.0 ExportMe</title>
<meta name="description" content="A Tool to Export a Scratch 3.0 project to HTML/JavaScript"/>
<noscript><meta http-equiv='refresh' content='0; url=https://grajeda.com/error/no-js.html' /></noscript>

<script>
function loadNoShow(){console.log("done loading"),document.getElementById("loadMe").style.display="none"}function loadShow(){console.log("loading..."),document.getElementById("loadMe").style.display="block"}
</script>

<style>
.loading{font-size:12px;font-color:#fff;background-color:#fff;text-align:center;letter-spacing:2px;margin-top:30px}
</style>

<style>
html{text-align:left;font-family:Arial,Helvetica,sans-serif;font-size:16pt;line-height:1.6}@media screen and (min-width:320px){html{text-align:left;font-family:Arial,Helvetica,sans-serif;font-size:calc(16px + 6 * ((100vw - 320px)/ 680));line-height:1.6}}@media screen and (min-width:750px){html{text-align:left;font-family:Arial,Helvetica,sans-serif;font-size:16px;line-height:1.6}}@media all and (min-width:551px){.mobile-br{display:inline}}@media all and (max-width:550px){.mobile-br{display:block;padding-top:10px!important;padding-bottom:10px!important}}.container{margin:0 auto;max-width:700px}
</style>
</head>

<body>
<div class="container">

<div id='loadMe' class='loading'>&nbsp; loading... &nbsp;</div>

<script>
function loadIt(){loadShow();var o=setInterval(function(){console.log("checking..."),"complete"==document.readyState&&(clearInterval(o),loadNoShow(),console.log("page loaded"))},100)}window.onload=loadIt();
</script>

<script>
const userId = 'aScratchUser'; const DESIRED_USERNAME = ''; const PROJECT_JSON = ''; const ASSETS = {};
</script>

<script type="module" src="./scratch-vm-exportMe.min.js"></script>

<!-- ********************************************************************** -->

<script type="module">
console.log('@ HTML... loaded VM')
var vm = new window.VirtualMachine();
window.runBenchmark = (() => {
  const collecteyData = {assets: {}};
  const getProjectUrl = function (asset) {
  const assetIdParts = asset.assetId.split('.');
  const assetUrlParts = ['https://projects.scratch.mit.edu/', assetIdParts[0]];
  if (assetIdParts[1]) {
      assetUrlParts.push(assetIdParts[1]);
  }
  return collecteyData.projectJSON = assetUrlParts.join('');
  };
  const getAssetUrl = function (asset) {
  const assetUrlParts = [
      'https://cdn.assets.scratch.mit.edu/',
      'internalapi/asset/',
      asset.assetId,
      '.',
      asset.dataFormat,
      '/get/'
  ];
  return collecteyData.assets[asset.assetId] = assetUrlParts.join('');
  };
  const runBenchmark = function (id) {
  return new Promise(res => {
  const storage = new ScratchStorage(); 
  const AssetType = storage.AssetType;
  storage.addWebStore([AssetType.Project], getProjectUrl);
  storage.addWebStore([AssetType.ImageVector, AssetType.ImageBitmap, AssetType.Sound], getAssetUrl);
  vm.attachStorage(storage);
  vm.downloadProjectId(id);
  vm.on('workspaceUpdate', () => {
      res(collecteyData);
  });
  vm.start();
  });
};
return runBenchmark;
})(); 
</script>

<!-- ********************************************************************** -->

<h1>Scratch 3.0 ExportMe</h1>
<hr>

<h3><em>Export a Scratch 3.0 project to HTML/JavaScript</em></h3>

<p>This exports a Scratch project into an HTML file. You then transfer this
file to your favorite webhost (AWS, Firebase, Google, GitHub, etc.) where it
can run on its own. 

<p>NOTE 1: The HTML file will be big; it will contain all the assets used in the Scratch project.
However, the exported file will NOT support Scratch Cloud Variables.</p>

<p>NOTE 2: The file will include links to various software that is not part of the Scratch project.
This includes a custom & minified Scratch virtual machine. When using the HTML file, 
the exported project will automatically start (there are no Scratch controls).</p>

<hr>

<p><label for="title">Project title: </label><input type="text" placeholder="Project title" value="Clicker Balloon" id="title" title="Text to display in the page tab"></p>
<p><label for="id">Project ID: </label><input type="number" placeholder="Project ID" value="283076965" id="id" title="ID of the project hosted on the Scratch website to convert"></p>

<button id="load-all">ExportMe</button>

<br><p>

<textarea style="max-width: 99%; max-height: 200px;"id="error" rows="8" cols="55" placeholder="Tool feedback will be shown here aka log" readonly></textarea>

<p>
Code upgrade to SheepMaker/Jeulibre. For technical details, view <a target="_blank" href="url_goes_here">Github Repo</a>.
<p>

</div>

<!-- ********************************************************************** -->

<script type="text/javascript">
const scratchURLs = [ 
  ''
];
function getDataURL(url) {
  console.log('@ getDataURL')
  return fetch(url).then(r => r.blob()).then(blob => new Promise(res => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.readAsDataURL(blob);
  }));
}
function downloadAsHTML(id, {title = 'Project', userId = 'ExportedFile', noVM = false, minify = false, log = console.log}) {
  console.log('@ downloadAsHTML')
  return runBenchmark(id).then(({assets, projectJSON}) => {
    log('Getting assets...');
    return Promise.all([
      Promise.all((noVM ? ['blank.html'] : scratchURLs).map(url => fetch(url).then(r => r.text()))).then(scripts => {
        console.log('Scratch scripts obtained')
        log('Scratch scripts obtained...');
        return scripts.join('\n');
      }),
      fetch(noVM ? './template_a.html' : './template_b.html')
        .then(r => r.text()),
      getDataURL(projectJSON)
        .then(data => projectJSON = data),
        ...Object.keys(assets).map(assetId => getDataURL(assets[assetId]).then(data => assets[assetId] = data))
      ])
    .then(async ([scripts, html]) => {
      scripts = `const PROJECT_JSON = "${projectJSON}";\nconst ASSETS = ${JSON.stringify(assets)};\nconst DESIRED_USERNAME = ${JSON.stringify(userId)};\n` + scripts.replace('</scr' + 'ipt>', '');
     
      log('Done!');
      console.log('Done!')
      return html.replace('{TITLE}', () => title).replace('{SCRIPTS}', () => scripts);
    });
  });
}
const loadBtn = document.getElementById('load-all');
const buttons = [loadBtn];
const title = document.getElementById('title');
const id = document.getElementById('id');
const error = document.getElementById('error');
loadBtn.addEventListener('click', e => {
  console.clear();
  console.log('@ loadBtn')
  buttons.forEach(btn => btn.disabled = true);
  error.value = '';
  downloadAsHTML(id.value, {title: title.value, username: userId, noVM: true, log: output => error.value += output + '\n'})
    .then(html => {
      download(html, 'project.html', 'text/html');
      buttons.forEach(btn => btn.disabled = false);
    }).catch(err => {
      console.log(err);
      error.value = err.message;
      buttons.forEach(btn => btn.disabled = false);
    });
});
</script>

<script src="./download.min.js"></script>

<div id="w">
<canvas id="s"></canvas>
<div id="m"></div>
</div>

</body>
</html>
