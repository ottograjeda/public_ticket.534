const scratchURLs = [ 
  ''
];
function getDataURL(url) {
  console.log('@ getDataURL')
  return fetch(url).then(r => r.blob()).then(blob => new Promise(res => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.readAsDataURL(blob);
  }));
}
function downloadAsHTML(id, {title = 'Project', userId = 'ExportedFile', noVM = false, minify = false, log = console.log}) {
  document.getElementById('feedbackArea').innerHTML = "";
  document.getElementById('feedbackArea').innerHTML += "Tool working ...<br>";
  document.body.style.cursor = 'wait';
  console.log('@ downloadAsHTML')
  return runBenchmark(id).then(({assets, projectJSON}) => {
    document.getElementById('feedbackArea').innerHTML += "Getting assets ...<br>";
    return Promise.all([
      Promise.all((noVM ? ['blank.html'] : scratchURLs).map(url => fetch(url).then(r => r.text()))).then(scripts => {
        console.log('Scratch scripts obtained')
        document.getElementById('feedbackArea').innerHTML += "Scratch scripts obtained ...<br>";
        document.getElementById('feedbackArea').innerHTML += "Creating file ...<br>";
        return scripts.join('\n');
      }),
      fetch(noVM ? './template_a.html' : './template_b.html')
      .then(r => r.text()),
      getDataURL(projectJSON)
        .then(data => projectJSON = data),
        ...Object.keys(assets).map(assetId => getDataURL(assets[assetId]).then(data => assets[assetId] = data))
      ])
    .then(async ([scripts, html]) => {
      scripts = `const PROJECT_JSON = "${projectJSON}";\nconst ASSETS = ${JSON.stringify(assets)};\nconst DESIRED_USERNAME = ${JSON.stringify(userId)};\n` + scripts.replace('</scr' + 'ipt>', '');
      document.getElementById('feedbackArea').innerHTML += "Export Done ! Click 'Save File'<br>";
      document.getElementById('feedbackArea').innerHTML += "- - - - - - - - - - - - - - - - - - - - - - - - <br>";
      document.getElementById('feedbackArea').innerHTML += "Tool done<br>";
      console.log('Done!')
      document.body.style.cursor = 'default';
      return html.replace('{TITLE}', () => title).replace('{SCRIPTS}', () => scripts);
    });
  });
}
const loadBtn = document.getElementById('load-all');
const buttons = [loadBtn];
const title = document.getElementById('title');
const id = document.getElementById('id');
const error = document.getElementById('error');
loadBtn.addEventListener('click', e => {
  console.log('prevent default = stop page from reloading (which is normal default form behavior) = allows file download for firefox')
  event.preventDefault();
  console.clear();
  console.log('@ loadBtn')
  buttons.forEach(btn => btn.disabled = true);
  downloadAsHTML(id.value, {title: title.value, username: userId, noVM: true, log: output => error.value += output + '\n'})
    .then(html => {
      download(html, 'project.html', 'text/html');
      buttons.forEach(btn => btn.disabled = false);
    }).catch(err => {
      console.log(err);
      error.value = err.message;
      buttons.forEach(btn => btn.disabled = false);
    });
});